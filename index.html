<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absensi — Sync via Gist</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; connect-src https://api.github.com https://docs.google.com https://docs.gstatic.com; frame-ancestors 'none'; base-uri 'none'">
  <style>
    :root {
      --bg: #0b0f14; --card:#121821; --muted:#1a2330; --text:#e8eef6; --sub:#a9b7c6; --acc:#4da3ff; --danger:#ff5470; --ok:#2ecc71;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    html,body { height:100%; background:var(--bg); color:var(--text); margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .card { background: var(--card); border: 1px solid #223146; border-radius: 14px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.35);}
    h1 { margin: 0 0 10px; font-size: 22px; letter-spacing: .3px;}
    .muted { color: var(--sub); font-size: 13px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items: center; }
    .row > * { flex: 1 1 auto; }
    label { font-size: 12px; color: var(--sub); display:block; margin-bottom: 6px;}
    input[type="text"], input[type="password"], input[type="url"], textarea, select {
      width:100%; box-sizing:border-box; background: var(--muted); color: var(--text); border:1px solid #2a3b52;
      border-radius:10px; padding:10px 12px; font-size:14px; outline:none; transition: border .15s;
    }
    textarea { min-height: 260px; font-family: var(--mono); line-height: 1.4; }
    input:focus, textarea:focus { border-color: var(--acc); }
    .btnbar { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;}
    button, .btn {
      background: #223146; color: var(--text); border: 1px solid #2a3b52; border-radius: 10px; padding: 10px 14px; font-weight: 600;
      cursor: pointer; transition: background .15s, transform .02s;
    }
    button.primary { background: var(--acc); color:#031323; border-color: #1c6ed1; }
    button.ok { background: var(--ok); color:#062311; border-color:#1e8b54; }
    button.danger { background: var(--danger); color:#2b050b; border-color:#b21c32; }
    button:active { transform: translateY(1px); }
    .tag { display:inline-block; padding:2px 8px; border-radius: 999px; font-size: 12px; border:1px solid #2a3b52; background:#182131; color:var(--sub)}
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px;}
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }
    .hint { font-size:12px; color: var(--sub); margin-top:6px; }
    .hr { height:1px; background:#223146; margin:16px 0; border:0;}
    .inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .right { margin-left:auto; }
    .link { color: var(--acc); text-decoration:none; }
    .link:hover { text-decoration:underline; }
    .toast { position: fixed; right: 16px; bottom: 16px; background: #0d1724; color: var(--text); border:1px solid #2a3b52; padding: 10px 14px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,.45); display:none;}
    .kbd { font-family: var(--mono); background:#0d1724; padding:1px 6px; border:1px solid #2a3b52; border-radius:6px; font-size:12px; }
    .warn { color:#ffbd59; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Absensi — Sync via Gist</h1>
      <div class="muted">Tidak ada Gist ID/Token di file ini. Kredensial diambil runtime dari Google Docs publish-to-web.</div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <label>Link Google Docs (publish-to-web)</label>
          <input id="docUrl" type="url" placeholder="https://docs.google.com/document/d/e/.../pub?output=txt" autocomplete="off" />
          <div class="hint">
            Dokumen harus berisi 2 baris: Baris-1 = GIST_ID, Baris-2 = TOKEN.
          </div>
        </div>
        <div>
          <div class="row">
            <div>
              <label>Filename di Gist (harus sama dengan yang dipakai app)</label>
              <input id="filename" type="text" value="absensi-settings.json" autocomplete="off"/>
              <div class="hint">Default app: absensi-settings.json. Case-sensitive.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="btnbar">
        <button id="btnFetchCreds" class="primary">1) Ambil Gist ID & Token dari Docs</button>
        <button id="btnTestCreds">Tes Kredensial</button>
        <span class="inline right muted">
          <label class="inline" style="gap:6px;">
            <input id="remember" type="checkbox"/> Remember locally
          </label>
          <button id="btnClear" class="danger">Hapus yang tersimpan</button>
          <span> | Status: <span id="status" class="warn">Idle</span></span>
        </span>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <label>Gist ID</label>
          <input id="gistId" type="text" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off" />
        </div>
        <div>
          <label>GitHub Token (scope: gist)</label>
          <input id="token" type="password" placeholder="ghp_xxx..." autocomplete="off" />
        </div>
      </div>

      <div class="btnbar">
        <button id="btnLoad" class="">2) Muat JSON dari Gist</button>
        <button id="btnSave" class="ok">3) Simpan JSON ke Gist</button>
        <button id="btnDownload">Unduh JSON</button>
        <label class="btn" for="fileInput">Muat JSON (file)…</label>
        <input id="fileInput" type="file" accept="application/json" style="display:none" />
        <span class="right"><a id="openGist" class="link" href="#" target="_blank" rel="noopener">Buka Gist</a></span>
      </div>

      <div class="hr"></div>

      <label>Data JSON</label>
      <textarea id="jsonArea" placeholder="{ ... }"></textarea>

      <div class="hint">
        • Setelah Load, kamu bisa copy JSON ke app atau langsung Save untuk update storage di Gist.  
        • Gunakan Ctrl/⌘+S di sini untuk cepat menyimpan ke Gist.
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // preset docs url (hardcoded) — no secrets
    const PRESET_DOC_URL = "https://docs.google.com/document/u/1/d/e/2PACX-1vSw0DNyopCzYwRF9LuAnecyNE_sv0HJYplvaj38ZfRfLj8SmVYJwjMxCi-clKmuIktBOwN8jlGTpaEI/pub?output=txt";

    const $ = sel => document.querySelector(sel);
    const showToast = (msg) => { const t = document.getElementById('toast'); t.textContent = msg; t.style.display = 'block';
      clearTimeout(window.__toastT); window.__toastT = setTimeout(()=> t.style.display='none', 2600); };
    const setStatus = (msg, ok=false) => { const s = document.getElementById('status'); s.textContent = msg; s.style.color = ok ? '#8ee39c' : '#ffbd59'; };

    async function fetchCredsFromDoc(url) {
      if (!url) throw new Error("URL Google Docs kosong");
      if (!/\?output=txt($|&)/.test(url)) url += (url.includes('?') ? '&' : '?') + 'output=txt';
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error("Gagal mengambil dokumen (" + res.status + ")");
      const text = await res.text();
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      // plaintext dua baris
      if (lines.length >= 2 && /^[a-f0-9]{32}$/i.test(lines[0]) && /^gh[pous]_[A-Za-z0-9_]{20,}/.test(lines[1])) {
        return { gistId: lines[0], token: lines[1] };
      }
      // fallback HTML scrape
      const idMatch = text.match(/\b[a-f0-9]{32}\b/i);
      const tkMatch = text.match(/\bgh[pous]_[A-Za-z0-9_]{20,}\b/);
      if (idMatch && tkMatch) return { gistId: idMatch[0], token: tkMatch[0] };
      throw new Error("Tidak menemukan Gist ID / Token di dokumen.");
    }

    async function getGist({ gistId, token }) {
      const url = "https://api.github.com/gists/" + gistId;
      const headers = { "Accept": "application/vnd.github+json" };
      if (token) headers["Authorization"] = "Bearer " + token;
      const res = await fetch(url, { headers });
      if (res.status === 404) throw new Error("404 — Gist tidak ditemukan atau tidak bisa diakses.");
      if (!res.ok) throw new Error("Gagal GET Gist (" + res.status + ")");
      return await res.json();
    }

    async function loadJsonFromGist({ gistId, filename, token }) {
      const data = await getGist({ gistId, token });
      const f = data.files && data.files[filename];
      if (!f) throw new Error('File "' + filename + '" tidak ada di Gist');
      if (f.truncated && f.raw_url) {
        const raw = await fetch(f.raw_url);
        if (!raw.ok) throw new Error("Gagal memuat raw_url");
        return await raw.text();
      }
      return f.content || "";
    }

    async function saveJsonToGist({ gistId, filename, token, content }) {
      if (!token) throw new Error("Token wajib untuk menyimpan.");
      const url = "https://api.github.com/gists/" + gistId;
      const res = await fetch(url, {
        method: "PATCH",
        headers: {
          "Authorization": "Bearer " + token,
          "Accept": "application/vnd.github+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ files: { } })
      });
      // tambahkan konten setelah membangun objek, untuk browser lama
      const body = { files: {} }; body.files[filename] = { content };
      const res2 = await fetch(url, {
        method: "PATCH",
        headers: {
          "Authorization": "Bearer " + token,
          "Accept": "application/vnd.github+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      if (!res2.ok) {
        const t = await res2.text().catch(()=> "");
        throw new Error("Gagal PATCH Gist (" + res2.status + ") " + t);
      }
      return await res2.json();
    }

    async function doFetchCreds() {
      const url = document.getElementById('docUrl').value.trim();
      try {
        const creds = await fetchCredsFromDoc(url);
        document.getElementById('gistId').value = creds.gistId;
        document.getElementById('token').value  = creds.token;
        document.getElementById('openGist').href = "https://gist.github.com/" + creds.gistId;
        setStatus("Kredensial diambil dari Docs", true);
        showToast("Berhasil ambil Gist ID & Token dari Docs");
        if (document.getElementById('remember').checked) {
          localStorage.setItem('sync.gistId', creds.gistId);
          localStorage.setItem('sync.token', creds.token);
          localStorage.setItem('sync.filename', document.getElementById('filename').value.trim());
          localStorage.setItem('sync.docUrl', url);
        }
      } catch (e) {
        setStatus("Gagal ambil dari Docs", false);
        showToast(e.message);
      }
    }

    async function doTestCreds() {
      const gistId = document.getElementById('gistId').value.trim();
      const token  = document.getElementById('token').value.trim();
      try { await getGist({ gistId, token }); setStatus("Kredensial valid ✔", true); showToast("Tes berhasil"); }
      catch (e) { setStatus("Kredensial bermasalah ✖", false); showToast(e.message); }
    }

    async function doLoad() {
      const gistId  = document.getElementById('gistId').value.trim();
      const token   = document.getElementById('token').value.trim();
      const fname   = document.getElementById('filename').value.trim();
      try {
        const txt = await loadJsonFromGist({ gistId, filename: fname, token });
        document.getElementById('jsonArea').value = txt;
        setStatus("JSON termuat dari Gist", true);
        showToast("Muat JSON OK");
      } catch (e) {
        showToast(e.message);
        setStatus("Gagal memuat JSON", false);
      }
    }

    async function doSave() {
      const gistId  = document.getElementById('gistId').value.trim();
      const token   = document.getElementById('token').value.trim();
      const fname   = document.getElementById('filename').value.trim();
      const txt     = document.getElementById('jsonArea').value;
      if (txt.trim()) { try { JSON.parse(txt); } catch { return showToast("JSON tidak valid — cek koma/kurung"); } }
      try {
        await saveJsonToGist({ gistId, filename: fname, token, content: txt });
        setStatus("Tersimpan ke Gist", true);
        showToast("Simpan JSON OK");
      } catch (e) {
        showToast(e.message);
        setStatus("Gagal menyimpan JSON", false);
      }
    }

    function doDownload() {
      const blob = new Blob([document.getElementById('jsonArea').value], { type: "application/json" });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = document.getElementById('filename').value.trim() || 'absensi-settings.json';
      a.click(); URL.revokeObjectURL(a.href);
    }

    function handleFile(ev) {
      const f = ev.target.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = () => { document.getElementById('jsonArea').value = reader.result; showToast("File dimuat ke editor"); };
      reader.readAsText(f); ev.target.value = "";
    }

    function clearStored() {
      localStorage.removeItem('sync.gistId');
      localStorage.removeItem('sync.token');
      localStorage.removeItem('sync.filename');
      localStorage.removeItem('sync.docUrl');
      showToast("Local storage dibersihkan"); setStatus("Cleared", false);
    }

    window.addEventListener('keydown', (e)=>{ if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); doSave(); } });

    document.getElementById('btnFetchCreds').addEventListener('click', doFetchCreds);
    document.getElementById('btnTestCreds').addEventListener('click', doTestCreds);
    document.getElementById('btnLoad').addEventListener('click', doLoad);
    document.getElementById('btnSave').addEventListener('click', doSave);
    document.getElementById('btnDownload').addEventListener('click', doDownload);
    document.getElementById('fileInput').addEventListener('change', handleFile);
    document.getElementById('btnClear').addEventListener('click', clearStored);

    (function init(){
      document.getElementById('docUrl').value = PRESET_DOC_URL;
    })();
  </script>
</body>
</html>
