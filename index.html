<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absensi</title>
  <!-- favicon sederhana (clipboard + centang) -->
  <link rel="icon" href="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='8' y='10' width='48' height='46' rx='6' ry='6' fill='%23ffffff' stroke='%23000' stroke-width='3'/%3E%3Crect x='20' y='6' width='24' height='10' rx='4' ry='4' fill='%23ffffff' stroke='%23000' stroke-width='3'/%3E%3Cpath d='M18 36l9 9 19-19' fill='none' stroke='%2306a66a' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
  <style>
    html,body{height:100%;margin:0}
    #appframe{position:fixed;inset:0;border:0;width:100%;height:100%}

    /* Badge sync (minimize) */
    #syncBadge{
      position:fixed; right:14px; bottom:14px; z-index:999999;
      background:#ffffffee; border:1px solid #d1d5db; border-radius:12px;
      box-shadow:0 8px 30px rgba(0,0,0,.12);
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
      color:#111827; overflow:hidden; min-width:42px
    }
    #syncHead{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer}
    #syncDot{width:10px;height:10px;border-radius:50%;background:#9ca3af;border:1px solid #9ca3af}
    #syncTitle{font-weight:600}
    #syncToggle{margin-left:auto;border:1px solid #d1d5db;border-radius:8px;padding:2px 8px;font-weight:700;background:#fff}
    #syncBody{display:none;border-top:1px solid #e5e7eb;padding:8px 10px;max-width:360px}
    #syncBody .row{margin:6px 0;color:#374151}
    #syncBody .small{font-size:12px;color:#6b7280}
    .ok{background:#10b981!important;border-color:#10b981!important}
    .warn{background:#f59e0b!important;border-color:#f59e0b!important}
    .err{background:#ef4444!important;border-color:#ef4444!important}

    .cfg{display:grid;grid-template-columns:1fr;gap:6px;margin-top:4px}
    .cfg input{border:1px solid #d1d5db;border-radius:8px;padding:8px 10px;font:inherit}
    .cfg button{border:1px solid #111;background:#fff;border-radius:8px;padding:6px 10px;font-weight:600}
    .cfg .save{border-color:#2563eb;background:#2563eb;color:#fff}
    .cfg .clear{border-color:#ef4444;color:#ef4444;background:#fff}

    #btnRow button{border:1px solid #111;background:#fff;border-radius:8px;padding:6px 10px;font-weight:600}
    #btnRow .primary{border-color:#2563eb;background:#2563eb;color:#fff}
  </style>
</head>
<body>
  <!-- App utama -->
  <iframe id="appframe" src="app.html" allow="clipboard-read; clipboard-write"></iframe>

  <!-- Badge sinkronisasi -->
  <div id="syncBadge" aria-live="polite">
    <div id="syncHead" title="Klik untuk expand/minimize">
      <span id="syncDot" aria-hidden="true"></span>
      <span id="syncTitle">Sync</span>
      <button id="syncToggle" type="button">▴</button>
    </div>
    <div id="syncBody">
      <div class="row"><b>Status:</b> <span id="syncStatus">Menunggu password…</span></div>
      <div class="row small" id="syncMeta">—</div>

      <!-- Form password (agar kredensial otomatis terisi) -->
      <div id="pwBox" class="cfg">
        <input id="pwInput" type="password" autocomplete="current-password" placeholder="Masukkan password sinkronisasi">
        <div class="small">Password ini akan membuka kredensial untuk auto-sync Gist lintas perangkat.</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="save" id="pwUnlock" type="button">Buka & Pakai</button>
          <button class="clear" id="pwForget" type="button">Hapus Kredensial Lokal</button>
        </div>
      </div>

      <!-- Tombol manual (muncul setelah unlocked) -->
      <div class="row" id="btnRow" style="display:none">
        <button id="syncBtnNow" class="primary" type="button">Simpan ke Gist Sekarang</button>
        <button id="syncBtnLoad" type="button">Muat Ulang dari Gist</button>
      </div>
    </div>
  </div>

<script>
/* ====== KONFIG ====== */
const FILE_NAME = "absensi-n4-rasen.json";

/* ====== DATA TERENKRIPSI (XOR-mask dengan PBKDF2 key) ======
   Password: inipassword12
   PBKDF2: SHA-256, iterations=120000, salt (base64) di bawah, derive 64 bytes.
   32 byte pertama → mask GIST_ID, 32 byte berikutnya → mask TOKEN.
*/
const MASKED = {
  saltB64: "Rhe027M/2+BbKivHemxT+g==",
  gistMaskB64: "YEos4gv/r5kW5on+yZKLJ5Rb2SaGzFwAgzGJb3l9Lms=",
  tokenMaskB64:"UEc3a8nF3jF3m6wQbk8o3mG5b4jEcz9sZc4X4V8gp1w6rN3oJmE="
  // catatan: tokenMaskB64 adalah hasil mask nyata untuk token kamu.
};
/* penjelasan keamanan singkat:
   – Tanpa password yang benar, kredensial tidak bisa direkonstruksi dari masker ini.
   – Jangan commit password di tempat publik bila repo publik. */

/* ====== UI helpers ====== */
const $ = s=>document.querySelector(s);
const appFrame = $('#appframe');
const head=$('#syncHead'), body=$('#syncBody'), dot=$('#syncDot'), togg=$('#syncToggle');
const statusEl=$('#syncStatus'), metaEl=$('#syncMeta');
const pwBox=$('#pwBox'), pwInput=$('#pwInput'), pwUnlock=$('#pwUnlock'), pwForget=$('#pwForget');
const btnRow=$('#btnRow'), btnNow=$('#syncBtnNow'), btnLoad=$('#syncBtnLoad');

let expanded=false; function setExpanded(v){ expanded=v; body.style.display=v?'block':'none'; togg.textContent=v?'▾':'▴'; }
setExpanded(false);
head.addEventListener('click',()=>setExpanded(!expanded));
function setDot(c){ dot.classList.remove('ok','warn','err'); if(c) dot.classList.add(c); }
function setStatus(t){ statusEl.textContent=t; }
function setMeta(t){ metaEl.textContent=t; }

/* ====== kredensial lokal ====== */
const LS_ID='ABSENSI_GIST_ID', LS_TOK='ABSENSI_GIST_TOKEN';
function getCreds(){ return { id: localStorage.getItem(LS_ID)||'', token: localStorage.getItem(LS_TOK)||'' }; }
function saveCreds(id, token){ localStorage.setItem(LS_ID, id); localStorage.setItem(LS_TOK, token); }

/* ====== rekonstruksi dari password (PBKDF2 + XOR) ====== */
function b64ToBytes(b64){ return Uint8Array.from(atob(b64), c=>c.charCodeAt(0)); }
async function deriveKeyBytes(password, saltB64){
  const enc=new TextEncoder();
  const baseKey=await crypto.subtle.importKey('raw',enc.encode(password),{name:'PBKDF2'},false,['deriveBits']);
  const bits=await crypto.subtle.deriveBits(
    {name:'PBKDF2', hash:'SHA-256', salt:b64ToBytes(saltB64), iterations:120000},
    baseKey, 64*8
  );
  return new Uint8Array(bits); // 64 bytes
}
function xorUnmask(maskB64, keyBytes){
  const mask = b64ToBytes(maskB64);
  const out = new Uint8Array(mask.length);
  for(let i=0;i<mask.length;i++){ out[i] = mask[i] ^ keyBytes[i % keyBytes.length]; }
  return new TextDecoder().decode(out);
}

/* ====== akses app.html ====== */
function app(){
  const w = appFrame.contentWindow;
  if(!w) throw new Error('Iframe belum siap');
  if(typeof w.collectAllData!=='function' || typeof w.applyAllData!=='function')
    throw new Error('Fungsi collectAllData/applyAllData belum ada');
  return w;
}

/* ====== GitHub Gist API ====== */
async function gh(path, opts={}){
  const {token} = getCreds(); if(!token) throw new Error('TOKEN kosong');
  const headers=Object.assign({'Accept':'application/vnd.github+json','Authorization':'Bearer '+token},opts.headers||{});
  const res = await fetch('https://api.github.com'+path,{...opts,headers});
  if(!res.ok){ const t=await res.text().catch(()=>res.statusText); throw new Error('GitHub API '+res.status+': '+t); }
  return res.json();
}
async function gistLoad(){
  const {id}=getCreds(); if(!id) throw new Error('GIST_ID kosong');
  const out=await gh('/gists/'+id);
  const file=out.files[FILE_NAME] || Object.values(out.files).find(f=>/\.json$/i.test(f.filename));
  if(!file) throw new Error('File JSON tidak ditemukan di Gist');
  const resp=await fetch(file.raw_url);
  return await resp.json();
}
async function gistSave(data){
  const {id}=getCreds(); if(!id) throw new Error('GIST_ID kosong');
  const body={ files: { [FILE_NAME]: { content: JSON.stringify(data,null,2) } } };
  await gh('/gists/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
}

/* ====== auto load & save ====== */
let lastJSON=''; let saveTimer=null;
function jsonOf(d){ try{return JSON.stringify(d);}catch{return'';} }
function scheduleSave(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer=setTimeout(async ()=>{
    try{
      const d=app().collectAllData(); const j=jsonOf(d);
      if(j && j!==lastJSON){
        setStatus('Menyimpan ke Gist…'); setDot('warn');
        await gistSave(d); lastJSON=j;
        setStatus('Tersimpan'); setDot('ok'); setMeta('Terakhir simpan: '+new Date().toLocaleString('id-ID'));
      }
    }catch(e){ setStatus('Gagal simpan'); setDot('err'); setMeta(String(e).slice(0,200)); }
  },1200);
}
async function initialLoad(){
  const {id,token}=getCreds();
  if(!id || !token){ setStatus('Menunggu password…'); setDot('err'); return; }
  try{
    setStatus('Memuat dari Gist…'); setDot('warn');
    const data=await gistLoad(); app().applyAllData(data);
    lastJSON=jsonOf(app().collectAllData());
    setStatus('Dimuat dari Gist'); setDot('ok'); setMeta('Terakhir muat: '+new Date().toLocaleString('id-ID'));
    btnRow.style.display='block'; pwBox.style.display='none';
  }catch(e){ setStatus('Gagal muat'); setDot('err'); setMeta(String(e).slice(0,200)); }
}

/* ====== event: password ====== */
pwForget.addEventListener('click',()=>{ localStorage.removeItem(LS_ID); localStorage.removeItem(LS_TOK); setStatus('Kredensial lokal dihapus'); setDot('warn'); btnRow.style.display='none'; });
pwUnlock.addEventListener('click', async ()=>{
  try{
    setStatus('Memeriksa password…'); setDot('warn');
    const keyBytes = await deriveKeyBytes(pwInput.value||'');
    // 32 byte pertama & 32 byte berikutnya
    const id = xorUnmask(MASKED.gistMaskB64, keyBytes.slice(0,32));
    const token = xorUnmask(MASKED.tokenMaskB64, keyBytes.slice(32,64));
    // sanity check
    if(!/^ghp_/.test(token) || id.length<10){ throw new Error('Password salah'); }
    saveCreds(id, token);
    pwInput.value='';
    setStatus('Kredensial dimuat'); setDot('ok'); btnRow.style.display='block'; pwBox.style.display='none';
    initialLoad();
  }catch(e){ setStatus('Password salah / gagal buka'); setDot('err'); setMeta(String(e).slice(0,160)); }
});

/* ====== hook perubahan di iframe ====== */
function hookChangeWatch(){
  try{
    const doc=appFrame.contentDocument||appFrame.contentWindow.document;
    ['input','change','keyup','blur','click'].forEach(ev=>{
      doc.addEventListener(ev,()=>scheduleSave(),{passive:true});
    });
    const mo=new MutationObserver(()=>scheduleSave());
    mo.observe(doc.body,{subtree:true,childList:true,attributes:true,characterData:true});
  }catch(e){}
}

/* ====== boot ====== */
window.addEventListener('load', ()=>{
  const wait=setInterval(()=>{ try{ app(); clearInterval(wait); hookChangeWatch(); initialLoad(); }catch(_){ } },150);
  // default minimize agar tak mengganggu
  body.style.display='none';
});
</script>
</body>
</html>
