<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absensi N4 Rasen – Portal</title>
  <style>
    html,body{height:100%;margin:0}
    #appframe{position:fixed;inset:0;border:0;width:100%;height:100%}
    .toolbar{position:fixed;right:12px;top:12px;z-index:999999;background:#ffffffee;border:1px solid #dbe0e6;border-radius:14px;padding:10px 12px;box-shadow:0 6px 30px rgba(0,0,0,.12);display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .toolbar input{height:32px;padding:0 10px;border:1px solid #cbd5e1;border-radius:10px}
    .toolbar button{height:32px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;padding:0 10px}
    .toolbar button:hover{background:#f3f5f7}
    .tag{font-size:12px;color:#64748b;padding:0 6px}
    @media (max-width:680px){.toolbar{left:12px;right:12px}}
  </style>
</head>
<body>
  <!-- NOTE: app.html adalah file absensi lama -->
  <iframe id="appframe" src="app.html" allow="clipboard-read; clipboard-write"></iframe>

  <div class="toolbar">
    <span class="tag">Local</span>
    <button id="btnSaveLocal">Simpan ke Perangkat</button>
    <button id="btnLoadLocal">Muat dari Perangkat</button>

    <span class="tag">Gist</span>
    <input id="gistToken" placeholder="GitHub Token (PAT)" style="width:230px" />
    <input id="gistId" placeholder="Gist ID (optional)" style="width:180px" />
    <button id="btnBackupGist">Backup ke Gist</button>
    <button id="btnRestoreGist">Pulihkan dari Gist</button>

    <span class="tag">Firebase</span>
    <input id="classKey" placeholder="Kelas Key (opsional)" style="width:180px" />
    <button id="fbLogin">Masuk Google</button>
    <button id="fbLogout" style="display:none;">Keluar</button>
    <button id="fbSave">Simpan ke Cloud</button>
    <button id="fbLoad">Muat dari Cloud</button>
  </div>

  <script>
  function cw(){ const f=document.getElementById('appframe'); return f && f.contentWindow; }
  function ensureReady(){
    const c = cw();
    if(!c) throw new Error('Iframe belum siap.');
    if(typeof c.collectAllData!=='function' || typeof c.applyAllData!=='function'){
      throw new Error('Fungsi collectAllData/applyAllData belum siap di app.');
    }
    return c;
  }

  // ====== Local Storage ======
  const LS_KEY='absensi_n4_rasen_snapshot_v1';
  document.getElementById('btnSaveLocal').onclick = () => {
    try{ const c=ensureReady(); localStorage.setItem(LS_KEY, JSON.stringify(c.collectAllData())); alert('Tersimpan di perangkat ✅'); }catch(e){ alert(e.message||e); }
  };
  document.getElementById('btnLoadLocal').onclick = () => {
    try{ const t=localStorage.getItem(LS_KEY); if(!t) return alert('Belum ada data lokal.'); const c=ensureReady(); c.applyAllData(JSON.parse(t)); alert('Data dimuat dari perangkat ✅'); }catch(e){ alert(e.message||e); }
  };
  window.addEventListener('beforeunload', () => { try{ const c=cw(); if(c&&c.collectAllData){ localStorage.setItem(LS_KEY, JSON.stringify(c.collectAllData())); } }catch(_){}});

  // ====== GitHub Gist ======
  const LS_TOKEN='absensi_n4_rasen_gist_token', LS_GIST='absensi_n4_rasen_gist_id';
  const tokenInput=document.getElementById('gistToken'); const gistInput=document.getElementById('gistId');
  tokenInput.value=localStorage.getItem(LS_TOKEN)||''; gistInput.value=localStorage.getItem(LS_GIST)||'';
  tokenInput.addEventListener('change', ()=> localStorage.setItem(LS_TOKEN, tokenInput.value.trim()));
  gistInput.addEventListener('change',  ()=> localStorage.setItem(LS_GIST,  gistInput.value.trim()));

  async function ghFetch(path, opts={}){
    const token=(tokenInput.value||'').trim(); if(!token) throw new Error('Isi GitHub Token dulu.');
    const headers=Object.assign({'Accept':'application/vnd.github+json','Authorization':'Bearer '+token}, opts.headers||{});
    const res=await fetch('https://api.github.com'+path, { ...opts, headers });
    if(!res.ok){ const t=await res.text(); throw new Error('GitHub API: '+res.status+' '+t); }
    return res.json();
  }
  document.getElementById('btnBackupGist').onclick = async () => {
    try{
      const c=ensureReady(); const content=JSON.stringify(c.collectAllData(), null, 2);
      const id=(gistInput.value||'').trim(); const file='absensi-n4-rasen.json';
      if(!id){
        const body={ description:'Backup Absensi N4 Rasen', public:false, files:{ [file]:{ content } } };
        const out=await ghFetch('/gists',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        gistInput.value=out.id; localStorage.setItem(LS_GIST,out.id); alert('Backup dibuat ✅\nGist ID: '+out.id);
      } else {
        const body={ files:{ [file]:{ content } } };
        await ghFetch('/gists/'+id,{ method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        alert('Backup diperbarui ✅');
      }
    }catch(e){ alert('Gagal backup: '+(e.message||e)); }
  };
  document.getElementById('btnRestoreGist').onclick = async () => {
    try{
      const id=(gistInput.value||'').trim(); if(!id) return alert('Isi Gist ID dahulu (atau lakukan Backup sekali).');
      const out=await ghFetch('/gists/'+id);
      const file=Object.values(out.files).find(f=>/\.json$/i.test(f.filename));
      if(!file) throw new Error('File JSON tidak ditemukan di Gist.');
      const resp=await fetch(file.raw_url); const data=await resp.json();
      const c=ensureReady(); c.applyAllData(data); alert('Pulihkan dari Gist ✅');
    }catch(e){ alert('Gagal pulihkan: '+(e.message||e)); }
  };
  </script>

  <!-- ====== Firebase SDK ====== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, onAuthStateChanged, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // GANTI dengan config project kamu
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const appframe = document.getElementById('appframe');
    const appWin = () => appframe && appframe.contentWindow;
    const needApp = () => {
      const w = appWin();
      if (!w || typeof w.collectAllData !== 'function' || typeof w.applyAllData !== 'function') {
        throw new Error('App belum siap di iframe.');
      }
      return w;
    };

    function getPath(uid) {
      const key = (document.getElementById('classKey').value || '').trim();
      if (key) return `classes/${encodeURIComponent(key)}`;
      if (uid) return `users/${uid}/absensi`;
      throw new Error('Isi Kelas Key atau login Google dulu.');
    }

    const btnLogin  = document.getElementById('fbLogin');
    const btnLogout = document.getElementById('fbLogout');
    const btnSave   = document.getElementById('fbSave');
    const btnLoad   = document.getElementById('fbLoad');

    btnLogin.onclick  = async () => { await signInWithPopup(auth, new GoogleAuthProvider()); };
    btnLogout.onclick = async () => { await signOut(auth); };

    onAuthStateChanged(auth, (user) => {
      btnLogin.style.display  = user ? 'none' : '';
      btnLogout.style.display = user ? '' : 'none';
      btnLogout.textContent   = user ? `Keluar (${user.email||user.displayName||'akun'})` : 'Keluar';
    });

    btnSave.onclick = async () => {
      try {
        const w   = needApp();
        const data = w.collectAllData();
        const uid  = auth.currentUser && auth.currentUser.uid;
        const path = getPath(uid);
        await set(ref(db, path), data);
        alert('✅ Tersimpan ke Firebase: ' + path);
      } catch (e) {
        alert('Gagal simpan: ' + e.message);
      }
    };

    btnLoad.onclick = async () => {
      try {
        const uid  = auth.currentUser && auth.currentUser.uid;
        const path = getPath(uid);
        const snap = await get(child(ref(db), path));
        if (!snap.exists()) return alert('Belum ada data di: ' + path);
        const w = needApp();
        w.applyAllData(snap.val());
        alert('✅ Dimuat dari Firebase: ' + path);
      } catch (e) {
        alert('Gagal muat: ' + e.message);
      }
    };
  </script>
</body>
</html>
