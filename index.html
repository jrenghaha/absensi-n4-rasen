# Create a polished, self-contained index.html that fetches Gist ID & token from Google Docs,
# never embeds secrets, supports remember-to-localStorage, and lets user test/load/save JSON.
doc_url = "https://docs.google.com/document/u/1/d/e/2PACX-1vSw0DNyopCzYwRF9LuAnecyNE_sv0HJYplvaj38ZfRfLj8SmVYJwjMxCi-clKmuIktBOwN8jlGTpaEI/pub?output=txt"

html = f"""<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Absensi — Sync via Gist (Index)</title>
  <!-- CSP: allow inline scripts, allow GitHub API & Google Docs -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 connect-src https://api.github.com https://docs.google.com https://docs.gstatic.com https://*.googleusercontent.com;
                 img-src 'self' data:;
                 frame-ancestors 'none'; base-uri 'none'">
  <style>
    :root {{
      --bg:#0c1118; --panel:#121a24; --muted:#162232; --text:#e8eef6; --sub:#a9b7c6;
      --acc:#4da3ff; --ok:#2ecc71; --warn:#ffbd59; --err:#ff5470; --border:#223146;
      --mono: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }}
    * {{ box-sizing:border-box; }}
    html,body {{ height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; }}
    .wrap {{ max-width:1100px; margin:28px auto; padding:0 16px; }}
    .card {{ background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow:0 10px 28px rgba(0,0,0,.32); }}
    h1 {{ margin:6px 0 0; font-size:24px; }}
    .muted {{ color:var(--sub); font-size:13px; }}
    .grid {{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }}
    @media (max-width: 900px) {{ .grid {{ grid-template-columns:1fr; }} }}
    label {{ display:block; font-size:12px; color:var(--sub); margin-bottom:6px; }}
    input[type=text], input[type=url], input[type=password], textarea, select {{
      width:100%; background:var(--muted); border:1px solid #2a3b52; border-radius:12px;
      padding:10px 12px; color:var(--text); font-size:14px; outline:none;
    }}
    textarea {{ min-height:260px; font-family:var(--mono); line-height:1.45; }}
    .row {{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }}
    .btn {{ background:#223146; color:var(--text); border:1px solid #2a3b52; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; }}
    .btn.primary {{ background:var(--acc); color:#061324; border-color:#1c6ed1; }}
    .btn.ok {{ background:var(--ok); color:#0a2414; border-color:#1e8b54; }}
    .btn.warn {{ background:var(--warn); color:#2b1c00; border-color:#936a00; }}
    .btn.danger {{ background:var(--err); color:#2b050b; border-color:#b21c32; }}
    .split {{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }}
    .status {{ font-size:13px; }}
    .badge {{ padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1928; }}
    .hr {{ height:1px; background:var(--border); margin:16px 0; }}
    a.link {{ color:var(--acc); text-decoration:none; }} a.link:hover {{ text-decoration:underline; }}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Absensi — Sync via Gist</h1>
      <div class="muted">Ambil <b>Gist ID</b> & <b>Token</b> dari Google Docs (publish-to-web) tanpa menanam rahasia di file. Bisa simpan ke <code>localStorage</code> agar <code>app.html</code> auto-sync.</div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <label>Link Google Docs (publish-to-web)</label>
          <input id="docUrl" type="url" value="{doc_url}" autocomplete="off">
          <div class="muted" style="margin-top:6px">Format dokumen: baris-1 = <b>GIST_ID</b>, baris-2 = <b>TOKEN</b>. URL otomatis pakai <code>?output=txt</code>.</div>
        </div>
        <div>
          <div class="row">
            <div style="flex:2 1 auto;">
              <label>Filename di Gist</label>
              <input id="filename" type="text" value="absensi-n4-rasen.json">
              <div class="muted" style="margin-top:6px">Case-sensitive. Harus sama dengan yang dipakai app.</div>
            </div>
            <div style="flex:1 1 220px">
              <label>Preset Filename</label>
              <select id="preset">
                <option value="">— pilih —</option>
                <option value="absensi-n4-rasen.json">absensi-n4-rasen.json</option>
                <option value="absensi-settings.json">absensi-settings.json</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnFetch" class="btn primary">1) Ambil Gist ID & Token dari Docs</button>
        <button id="btnTest" class="btn">Tes Kredensial</button>
        <label class="split" style="margin-left:auto">
          <input type="checkbox" id="remember">
          <span class="muted">Remember locally</span>
        </label>
        <span class="status">Status: <span id="status" class="badge">Idle</span></span>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <label>Gist ID</label>
          <input id="gistId" type="text" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
        </div>
        <div>
          <label>GitHub Token (scope: gist)</label>
          <input id="token" type="password" placeholder="ghp_… / github_pat_…">
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnLoad" class="btn">2) Muat JSON dari Gist</button>
        <button id="btnSave" class="btn ok">3) Simpan JSON ke Gist</button>
        <button id="btnDownload" class="btn">Unduh JSON</button>
        <a id="gistLink" target="_blank" class="link" style="margin-left:auto; display:none">Buka Gist ↗</a>
      </div>

      <div class="hr"></div>

      <label>Data JSON</label>
      <textarea id="jsonArea" placeholder="{{\\n  ...\\n}}"></textarea>
    </div>
  </div>

  <script>
    // ====== Helpers ======
    const LS = { id:'sync.gistId', tok:'sync.token', file:'sync.filename', doc:'sync.docUrl' };
    const $ = s => document.querySelector(s);
    const setStatus = (t, kind='idle') => { const el = $('#status'); el.textContent = t;
      el.style.color = ({{ idle:'#e8eef6', ok:'#8ee39c', warn:'#ffbd59', err:'#ff7a8a' }})[kind] || '#e8eef6';
    };
    const tokenRe = /(?:gh[pous]_[A-Za-z0-9_\\-]{{20,}}|github_pat_[A-Za-z0-9_\\-]{{20,}})/;

    function persist() {{
      if (!$('#remember').checked) return;
      localStorage.setItem(LS.id,  $('#gistId').value.trim());
      localStorage.setItem(LS.tok, $('#token').value.trim());
      localStorage.setItem(LS.file,$('#filename').value.trim() || 'absensi-n4-rasen.json');
      localStorage.setItem(LS.doc, $('#docUrl').value.trim());
    }}
    function hydrateFromLS() {{
      const id  = localStorage.getItem(LS.id)  || '';
      const tok = localStorage.getItem(LS.tok) || '';
      const file= localStorage.getItem(LS.file)|| '';
      const doc = localStorage.getItem(LS.doc) || '';
      if (id)  $('#gistId').value = id;
      if (tok) $('#token').value  = tok;
      if (file)$('#filename').value = file;
      if (doc) $('#docUrl').value = doc;
      if (id) {{ $('#gistLink').href = 'https://gist.github.com/'+id; $('#gistLink').style.display='inline'; }}
    }}

    async function fetchDocCreds(url) {{
      if (!/\\?output=txt(\\b|&)/.test(url)) url += (url.includes('?')? '&':'?') + 'output=txt';
      const res = await fetch(url, {{ mode:'cors' }});
      if (!res.ok) throw new Error('Gagal mengambil dokumen ('+res.status+')');
      const text = await res.text();

      // ambil 32-hex untuk ID + tokenRe untuk token dari mana saja dalam dokumen
      const idMatch = text.match(/\\b[a-f0-9]{{32}}\\b/i);
      const tkMatch = text.match(tokenRe);
      if (!idMatch || !tkMatch) throw new Error('Tidak menemukan Gist ID / Token di dokumen.');
      return {{ gistId: idMatch[0], token: tkMatch[0] }};
    }}

    async function gh(gistId, token, path='') {{
      const url = `https://api.github.com/gists/${{gistId}}${{path}}`;
      const res = await fetch(url, {{
        headers: {{
          'Authorization': 'Bearer ' + token,
          'Accept': 'application/vnd.github+json'
        }}
      }});
      return res;
    }}

    async function loadFromGist() {{
      const id = $('#gistId').value.trim(); const tok = $('#token').value.trim(); const file = $('#filename').value.trim();
      try {{
        setStatus('Memuat JSON…','warn');
        const res = await gh(id, tok);
        if (res.status === 404) throw new Error('404 — Gist tidak ditemukan atau tidak bisa diakses.');
        if (res.status === 401) throw new Error('401 — Token tidak valid.');
        if (!res.ok) throw new Error('Gagal GET Gist ('+res.status+')');
        const data = await res.json();
        const f = data.files && data.files[file];
        if (!f) throw new Error('File \"'+file+'\" tidak ada di Gist.');
        let txt = f.content || '';
        if (f.truncated && f.raw_url) {{ const r = await fetch(f.raw_url); txt = await r.text(); }}
        $('#jsonArea').value = txt;
        setStatus('JSON termuat dari Gist','ok');
        $('#gistLink').href = 'https://gist.github.com/'+id; $('#gistLink').style.display='inline';
        persist();
      }} catch(e) {{ setStatus('Gagal muat: '+e.message,'err'); }}
    }}

    async function saveToGist() {{
      const id = $('#gistId').value.trim(); const tok = $('#token').value.trim(); const file = $('#filename').value.trim();
      let txt = $('#jsonArea').value;
      try {{ if (txt.trim()) JSON.parse(txt); }} catch(e) {{ return alert('JSON tidak valid: '+e.message); }}
      try {{
        setStatus('Menyimpan ke Gist…','warn');
        const body = {{ files: {{}} }}; body.files[file] = {{ content: txt }};
        const res = await fetch('https://api.github.com/gists/'+id, {{
          method:'PATCH',
          headers: {{
            'Authorization':'Bearer '+tok,
            'Accept':'application/vnd.github+json',
            'Content-Type':'application/json'
          }},
          body: JSON.stringify(body)
        }});
        if (!res.ok) throw new Error('Gagal PATCH ('+res.status+')');
        setStatus('Tersimpan ke Gist','ok'); persist();
      }} catch(e) {{ setStatus('Gagal simpan: '+e.message,'err'); }}
    }}

    // ====== Wire UI ======
    document.addEventListener('DOMContentLoaded', () => {{
      hydrateFromLS();

      // Ambil kredensial dari Docs
      $('#btnFetch').addEventListener('click', async () => {{
        try {{
          setStatus('Mengambil dari Docs…','warn');
          const creds = await fetchDocCreds($('#docUrl').value.trim());
          $('#gistId').value = creds.gistId;
          $('#token').value  = creds.token;
          setStatus('Kredensial diambil dari Docs','ok');
          persist();
          $('#gistLink').href = 'https://gist.github.com/'+creds.gistId; $('#gistLink').style.display='inline';
        }} catch(e) {{ setStatus('Gagal ambil dari Docs: '+e.message,'err'); }}
      }});

      // Tes kredensial cepat
      $('#btnTest').addEventListener('click', async () => {{
        try {{
          setStatus('Tes kredensial…','warn');
          const r = await gh($('#gistId').value.trim(), $('#token').value.trim());
          if (!r.ok) throw new Error(r.status + ' — ' + (r.status===404?'Gist tidak ditemukan/izin kurang': 'HTTP error'));
          setStatus('Kredensial valid ✔','ok'); persist();
        }} catch(e) {{ setStatus('Tes gagal: '+e.message,'err'); }}
      }});

      $('#btnLoad').addEventListener('click', loadFromGist);
      $('#btnSave').addEventListener('click', saveToGist);
      $('#btnDownload').addEventListener('click', () => {{
        const blob = new Blob([$('#jsonArea').value], {{type:'application/json'}});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = $('#filename').value.trim() || 'absensi-n4-rasen.json'; a.click(); URL.revokeObjectURL(a.href);
      }});

      // Persist on change if remember on
      ['docUrl','filename','gistId','token'].forEach(id => $('#'+id).addEventListener('input', persist));
      $('#preset').addEventListener('change', e => {{ if (e.target.value) {{ $('#filename').value = e.target.value; persist(); }} }});
    }});
  </script>
</body>
</html>
"""
open('/mnt/data/index_final.html','w',encoding='utf-8').write(html)
open('/mnt/data/.nojekyll','w').write('')
"/mnt/data/index_final.html created"
