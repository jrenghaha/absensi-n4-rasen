<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi</title>
  <style>
    body{font-family:sans-serif;margin:2em;}
    #loginBox{border:1px solid #ccc;padding:1em;max-width:300px;}
    #status{margin-top:.5em;font-size:.9em;color:#555;}
    #app{display:none;}
    .ok{color:green;}
    .err{color:red;}
    .warn{color:orange;}
  </style>
</head>
<body>
  <h1>Absensi N4 Rasen</h1>

  <!-- Login password -->
  <div id="loginBox">
    <label>Masukkan Password:<br>
      <input type="password" id="pwInput">
    </label>
    <button id="btnLogin">Buka</button>
    <div id="status"></div>
  </div>

  <!-- Konten utama -->
  <div id="app">
    <p><b>Status Sync:</b> <span id="syncStatus">Belum login</span></p>
    <button id="btnSave">Simpan ke Gist</button>
    <button id="btnLoad">Muat dari Gist</button>
    <pre id="debug"></pre>
  </div>

<script>
const PASSWORD_CORRECT = "inipassword12";
const DOC_EXPORT_URL = "https://docs.google.com/document/d/e/2PACX-1vSUP5ZTsG5gF8BenDLq3Vv6rsbC7O2cP_Ru3cmE3kAOVMPsB_clIY8dBkDbBxB4RaT_6e7aZl-1OosK/pub";

const pwInput = document.getElementById("pwInput");
const btnLogin = document.getElementById("btnLogin");
const statusBox = document.getElementById("status");
const app = document.getElementById("app");
const syncStatus = document.getElementById("syncStatus");
const debug = document.getElementById("debug");

function setStatus(msg,cls=""){statusBox.textContent=msg;statusBox.className=cls;}
function saveCreds(id,token){
  localStorage.setItem("gistId",id);
  localStorage.setItem("gistToken",token);
}

btnLogin.onclick = async ()=>{
  const pass = (pwInput.value||"").trim();
  if(pass!==PASSWORD_CORRECT){ setStatus("Password salah","err"); return; }
  setStatus("Mengambil kredensialâ€¦","warn");
  try{
    const res = await fetch(DOC_EXPORT_URL,{mode:"cors"});
    let text = await res.text();

    // Jika HTML, parse isi jadi textContent
    if(/^\s*</.test(text)){
      const tmp = document.createElement("div");
      tmp.innerHTML=text;
      text=(tmp.textContent||"").replace(/\r/g,"");
    }
    const lines=text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const gistId=(lines.find(s=>/^[a-f0-9]{32}$/i.test(s))||lines[0]||"").trim();
    const token=(lines.find(s=>/^gh(p|ithub_pat_)/i.test(s))||lines[1]||"").trim();

    if(!/^[a-f0-9]{32}$/i.test(gistId)) throw new Error("Gist ID tidak valid");
    if(!/^gh(p|ithub_pat_)/i.test(token)) throw new Error("Token tidak valid");

    saveCreds(gistId,token);
    setStatus("Login berhasil","ok");
    document.getElementById("loginBox").style.display="none";
    app.style.display="block";
    syncStatus.textContent="Kredensial dimuat";
  }catch(e){
    setStatus("Gagal ambil kredensial: "+e.message,"err");
  }
};

// Demo tombol Save/Load
document.getElementById("btnSave").onclick=async()=>{
  const gistId=localStorage.getItem("gistId");
  const token=localStorage.getItem("gistToken");
  if(!gistId||!token){alert("Belum login");return;}
  try{
    const res=await fetch("https://api.github.com/gists/"+gistId,{
      method:"PATCH",
      headers:{ "Authorization":"token "+token,"Content-Type":"application/json"},
      body:JSON.stringify({files:{"absensi.json":{content:JSON.stringify({msg:"tes simpan "+Date.now()})}}})
    });
    const data=await res.json();
    debug.textContent=JSON.stringify(data,null,2);
    syncStatus.textContent="Data tersimpan ke Gist!";
  }catch(e){debug.textContent=e;}
};

document.getElementById("btnLoad").onclick=async()=>{
  const gistId=localStorage.getItem("gistId");
  const token=localStorage.getItem("gistToken");
  if(!gistId||!token){alert("Belum login");return;}
  try{
    const res=await fetch("https://api.github.com/gists/"+gistId,{
      headers:{ "Authorization":"token "+token}
    });
    const data=await res.json();
    debug.textContent=JSON.stringify(data,null,2);
    syncStatus.textContent="Data dimuat dari Gist!";
  }catch(e){debug.textContent=e;}
};
</script>
</body>
</html>
