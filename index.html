<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absensi — Sync via Gist</title>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 connect-src https://api.github.com https://docs.google.com https://docs.gstatic.com https://*.googleusercontent.com;
                 img-src 'self' data:;
                 frame-ancestors 'none'; base-uri 'none'">
  <style>
    :root {
      --bg: #0c1118; --card:#121a24; --muted:#172232; --text:#e8eef6; --sub:#a9b7c6; --acc:#4da3ff; --danger:#ff5470; --ok:#2ecc71;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; background:var(--bg); color:var(--text); margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .wrap { max-width: 1100px; margin: 28px auto; padding: 0 16px; }
    .card { background: var(--card); border: 1px solid #223146; border-radius: 16px; padding: 18px; box-shadow: 0 10px 28px rgba(0,0,0,.32);}
    h1 { margin: 0 0 6px; font-size: 24px; letter-spacing: .2px; }
    .muted { color: var(--sub); font-size: 13px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items: center; }
    .row > * { flex: 1 1 auto; min-width: 220px; }
    label { font-size: 12px; color: var(--sub); display:block; margin-bottom: 6px;}
    input[type="text"], input[type="password"], input[type="url"], textarea, select {
      width:100%; background: var(--muted); color: var(--text); border:1px solid #2a3b52;
      border-radius:12px; padding:10px 12px; font-size:14px; outline:none; transition: border .15s;
    }
    textarea { min-height: 260px; font-family: var(--mono); line-height: 1.4; }
    input:focus, textarea:focus { border-color: var(--acc); }
    .btnbar { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px;}
    button, .btn {
      background: #223146; color: var(--text); border: 1px solid #2a3b52; border-radius: 12px; padding: 10px 14px; font-weight: 600;
      cursor: pointer; transition: background .15s, transform .02s, opacity .2s;
    }
    button.primary { background: var(--acc); color:#031323; border-color: #1c6ed1; }
    button.ok { background: var(--ok); color:#062311; border-color:#1e8b54; }
    button.danger { background: var(--danger); color:#2b050b; border-color:#b21c32; }
    button:active { transform: translateY(1px); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px;}
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }
    .hint { font-size:12px; color: var(--sub); margin-top:6px; }
    .hr { height:1px; background:#223146; margin:16px 0; border:0;}
    .mask { position: fixed; inset:0; background: rgba(0,0,0,.68); display:flex; align-items:center; justify-content:center; }
    .modal { background:#0f1928; border:1px solid #2a3b52; border-radius:16px; width:min(520px, 90vw); padding:20px; box-shadow: 0 20px 60px rgba(0,0,0,.5); }
    .modal h2 { margin:0 0 10px; font-size:20px;}
    .modal small { color:var(--sub); }
  </style>
</head>
<body>
  <div id="gate" class="mask">
    <div class="modal">
      <h2>Kunci Akses</h2>
      <small>Masukkan password untuk memuat kredensial dari Google Docs.</small>
      <div class="row" style="margin-top:12px;">
        <input id="gatePw" type="password" placeholder="Password" autocomplete="off"/>
        <button id="gateBtn" class="primary" type="button">Buka</button>
      </div>
      <div id="gateMsg" class="hint" style="margin-top:8px;"></div>
    </div>
  </div>

  <div class="wrap" style="display:none" id="app">
    <div class="card">
      <h1>Absensi — Sync via Gist</h1>
      <div class="muted">Kredensial diambil otomatis dari Google Docs publish-to-web. Tidak ada token/Gist ID yang ditanam di file ini.</div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <label>Link Google Docs (publish-to-web)</label>
          <input id="docUrl" type="url" autocomplete="off" />
          <div class="hint">Dokumen berisi 2 baris: <b>Baris-1 = GIST_ID</b>, <b>Baris-2 = TOKEN</b>. URL otomatis pakai <code>?output=txt</code>.</div>
        </div>
        <div>
          <div class="row">
            <div style="flex:2 1 auto;">
              <label>Filename di Gist</label>
              <input id="filename" type="text" value="absensi-settings.json" autocomplete="off"/>
              <div class="hint">Case-sensitive.</div>
            </div>
            <div style="flex:1 1 220px;">
              <label>Preset Filename</label>
              <select id="preset">
                <option value="">— pilih —</option>
                <option value="absensi-settings.json">absensi-settings.json</option>
                <option value="absensi-n4-rasen.json">absensi-n4-rasen.json</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="btnbar">
        <button id="btnFetchCreds" class="primary">1) Ambil Gist ID & Token dari Docs</button>
        <button id="btnTestCreds">Tes Kredensial</button>
        <span class="muted" style="margin-left:auto">Status: <span id="status">Idle</span></span>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <label>Gist ID</label>
          <input id="gistId" type="text" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off" />
        </div>
        <div>
          <label>GitHub Token (scope: gist)</label>
          <input id="token" type="password" placeholder="ghp_xxx..." autocomplete="off" />
        </div>
      </div>

      <div class="btnbar">
        <button id="btnLoad" type="button">2) Muat JSON dari Gist</button>
        <button id="btnSave" class="ok" type="button">3) Simpan JSON ke Gist</button>
        <button id="btnDownload" type="button">Unduh JSON</button>
      </div>

      <div class="hr"></div>

      <label>Data JSON</label>
      <textarea id="jsonArea" placeholder="{ ... }"></textarea>
    </div>
  </div>

  <script>
    const ACCESS_PW = "inipassword12";
    const PRESET_DOC_URL = "https://docs.google.com/document/u/1/d/e/2PACX-1vSw0DNyopCzYwRF9LuAnecyNE_sv0HJYplvaj38ZfRfLj8SmVYJwjMxCi-clKmuIktBOwN8jlGTpaEI/pub?output=txt";

    const $ = s => document.querySelector(s);
    const setStatus = (t, ok=false) => { const el = $('#status'); el.textContent = t; el.style.color = ok ? '#8ee39c' : '#ffbd59'; };

    function tryOpenGate() {
      if ($('#gatePw').value === ACCESS_PW) {
        $('#gate').style.display = 'none';
        $('#app').style.display = 'block';
        $('#docUrl').value = PRESET_DOC_URL;
        doFetchCreds().catch(()=>{});
      } else {
        $('#gateMsg').textContent = 'Password salah.';
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      $('#gateBtn').addEventListener('click', tryOpenGate);
      $('#gatePw').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); tryOpenGate(); } });
    });

    async function fetchCredsFromDoc(url) {
      if (!url) throw new Error('URL Google Docs kosong');
      if (!/\\?output=txt($|&)/.test(url)) url += (url.includes('?') ? '&' : '?') + 'output=txt';
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error('Gagal mengambil dokumen (' + res.status + ')');
      const text = await res.text();
      const lines = text.split(/\\r?\\n/).map(s => s.trim()).filter(Boolean);

      // Accept two-line layout OR search anywhere (supports ghp_/gho_/ghs_/ghu_/github_pat_)
      const tokenRe = /(?:gh[pous]_[A-Za-z0-9_]{20,}|github_pat_[A-Za-z0-9_]{20,})/;
      if (lines.length >= 2 && /^[a-f0-9]{32}$/i.test(lines[0]) && tokenRe.test(lines[1])) {
        return { gistId: lines[0].match(/[a-f0-9]{32}/i)[0], token: lines[1].match(tokenRe)[0] };
      }
      const idMatch = text.match(/\b[a-f0-9]{32}\b/i);
      const tkMatch = text.match(tokenRe);
      if (idMatch && tkMatch) return { gistId: idMatch[0], token: tkMatch[0] };

      throw new Error('Tidak menemukan Gist ID / Token di dokumen.');
    }

    async function getGist({ gistId, token }) {
      const url = `https://api.github.com/gists/${gistId}`;
      const headers = { 'Accept': 'application/vnd.github+json' };
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(url, { headers });
      if (res.status === 404) throw new Error('404 — Gist tidak ditemukan atau tidak bisa diakses.');
      if (!res.ok) throw new Error('Gagal GET Gist (' + res.status + ')');
      return await res.json();
    }

    async function doFetchCreds() {
      try {
        setStatus('Mengambil kredensial…');
        const { gistId, token } = await fetchCredsFromDoc($('#docUrl').value.trim());
        $('#gistId').value = gistId;
        $('#token').value  = token;
        setStatus('Kredensial diambil dari Docs', true);
      } catch (e) {
        setStatus('Gagal ambil dari Docs', false);
        alert(e.message);
      }
    }

    async function doLoad() {
      const gistId  = $('#gistId').value.trim();
      const token   = $('#token').value.trim();
      const fname   = $('#filename').value.trim();
      try {
        setStatus('Memuat JSON…');
        const data = await getGist({ gistId, token });
        const f = data.files && data.files[fname];
        if (!f) throw new Error('File \"' + fname + '\" tidak ada di Gist');
        let txt = f.content || '';
        if (f.truncated && f.raw_url) {
          const r = await fetch(f.raw_url);
          if (!r.ok) throw new Error('Gagal memuat raw_url');
          txt = await r.text();
        }
        $('#jsonArea').value = txt;
        setStatus('JSON termuat dari Gist', true);
      } catch (e) {
        setStatus('Gagal memuat JSON', false);
        alert(e.message);
      }
    }

    async function doSave() {
      const gistId  = $('#gistId').value.trim();
      const token   = $('#token').value.trim();
      const fname   = $('#filename').value.trim();
      const txt     = $('#jsonArea').value;
      if (txt.trim()) { try { JSON.parse(txt); } catch { return alert('JSON tidak valid — cek koma/kurung.'); } }
      try {
        setStatus('Menyimpan ke Gist…');
        const url = `https://api.github.com/gists/${gistId}`;
        const body = { files: {} }; body.files[fname] = { content: txt };
        const res = await fetch(url, {
          method: 'PATCH',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Accept': 'application/vnd.github+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        if (!res.ok) {
          const t = await res.text().catch(()=>'');
          throw new Error('Gagal PATCH Gist (' + res.status + ') ' + t);
        }
        setStatus('Tersimpan ke Gist', true);
      } catch (e) {
        setStatus('Gagal menyimpan JSON', false);
        alert(e.message);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btnFetchCreds').addEventListener('click', doFetchCreds);
      document.getElementById('btnTestCreds').addEventListener('click', async () => {
        const gistId = document.getElementById('gistId').value.trim();
        const token  = document.getElementById('token').value.trim();
        try { await getGist({ gistId, token }); setStatus('Kredensial valid ✔', true); }
        catch (e) { setStatus('Kredensial bermasalah ✖', false); alert(e.message); }
      });
      document.getElementById('btnLoad').addEventListener('click', doLoad);
      document.getElementById('btnSave').addEventListener('click', doSave);
      document.getElementById('btnDownload').addEventListener('click', () => {
        const blob = new Blob([document.getElementById('jsonArea').value], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = document.getElementById('filename').value.trim() || 'absensi-settings.json';
        a.click(); URL.revokeObjectURL(a.href);
      });

      document.getElementById('preset').addEventListener('change', (e)=>{
        if (e.target.value) document.getElementById('filename').value = e.target.value;
      });
    });
  </script>
</body>
</html>
