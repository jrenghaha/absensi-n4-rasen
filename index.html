<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absensi N4 Rasen – Portal</title>
  <style>
    html,body{height:100%;margin:0}
    #appframe{position:fixed;inset:0;border:0;width:100%;height:100%}

    /* Sync badge (minimizable) */
    #syncBadge{
      position:fixed; right:14px; bottom:14px; z-index:999999;
      background:#ffffffee; border:1px solid #d1d5db; border-radius:12px;
      box-shadow:0 8px 30px rgba(0,0,0,.12);
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
      color:#111827; overflow:hidden; min-width:42px;
    }
    #syncHead{display:flex;align-items:center;gap:8px;padding:8px 10px;cursor:pointer}
    #syncDot{width:10px;height:10px;border-radius:50%;background:#9ca3af;border:1px solid #9ca3af}
    #syncTitle{font-weight:600}
    #syncToggle{margin-left:auto;border:1px solid #d1d5db;border-radius:8px;padding:2px 8px;font-weight:700;background:#fff}
    #syncBody{display:none;border-top:1px solid #e5e7eb;padding:8px 10px;max-width:320px}
    #syncBody .row{margin:4px 0;color:#374151}
    #syncBody .small{font-size:12px;color:#6b7280}
    #syncBtnNow{border:1px solid #2563eb;background:#2563eb;color:#fff;border-radius:8px;padding:6px 10px;font-weight:600}
    #syncBtnLoad{border:1px solid #111;background:#fff;border-radius:8px;padding:6px 10px;font-weight:600;margin-left:6px}
    .ok{background:#10b981!important;border-color:#10b981!important}
    .warn{background:#f59e0b!important;border-color:#f59e0b!important}
    .err{background:#ef4444!important;border-color:#ef4444!important}
  </style>
</head>
<body>
  <!-- App lama tetap dipakai di iframe -->
  <iframe id="appframe" src="app.html" allow="clipboard-read; clipboard-write"></iframe>

  <!-- Badge sinkronisasi (minimizable) -->
  <div id="syncBadge" aria-live="polite">
    <div id="syncHead" title="Klik untuk expand/minimize">
      <span id="syncDot" aria-hidden="true"></span>
      <span id="syncTitle">Sync</span>
      <button id="syncToggle" type="button">▴</button>
    </div>
    <div id="syncBody">
      <div class="row"><b>Status:</b> <span id="syncStatus">Menunggu app…</span></div>
      <div class="row small" id="syncMeta">—</div>
      <div class="row">
        <button id="syncBtnNow" type="button">Simpan ke Gist sekarang</button>
        <button id="syncBtnLoad" type="button">Muat ulang dari Gist</button>
      </div>
    </div>
  </div>

<script>
/** ===================  KONFIGURASI GIST  ===================
 *  Isi dua konstanta di bawah ini supaya tidak perlu input lagi di perangkat mana pun.
 *  GIST_TOKEN : GitHub PAT (scope: gist)
 *  GIST_ID    : ID Gist yang berisi file JSON absensi (misal: "2d2fd4d16a1036fdb26e09bd7c...")
 *  FILE_NAME  : Nama file di dalam gist tersebut.
 */
const GIST_TOKEN = "REPLACE_WITH_YOUR_PAT";      // <-- ISI DI SINI
const GIST_ID    = "REPLACE_WITH_YOUR_GIST_ID";  // <-- ISI DI SINI
const FILE_NAME  = "absensi-n4-rasen.json";

/** ===================  UTIL  =================== */
const $ = sel => document.querySelector(sel);
const appFrame = $('#appframe');
const badge = $('#syncBadge'), head = $('#syncHead'), body = $('#syncBody'), dot = $('#syncDot');
const statusEl = $('#syncStatus'), metaEl = $('#syncMeta');
const btnNow = $('#syncBtnNow'), btnLoad = $('#syncBtnLoad'), btnToggle = $('#syncToggle');

let expanded = false;
function setExpanded(v){
  expanded = v;
  body.style.display = v ? 'block' : 'none';
  btnToggle.textContent = v ? '▾' : '▴';
}
setExpanded(false);

head.addEventListener('click', ()=> setExpanded(!expanded));

function setDot(cls){
  dot.classList.remove('ok','warn','err');
  if (cls) dot.classList.add(cls);
}
function setStatus(text){ statusEl.textContent = text; }
function setMeta(text){ metaEl.textContent = text; }

/** ===================  AKSES APP  =================== */
function app() {
  const w = appFrame.contentWindow;
  if (!w) throw new Error('Iframe belum siap');
  if (typeof w.collectAllData !== 'function' || typeof w.applyAllData !== 'function') {
    throw new Error('Fungsi collectAllData/applyAllData belum tersedia');
  }
  return w;
}

/** ===================  GIST API  =================== */
async function gh(path, opts={}){
  if(!GIST_TOKEN || GIST_TOKEN.startsWith('REPLACE_')) throw new Error('GIST_TOKEN belum diisi');
  const headers = Object.assign({
    'Accept':'application/vnd.github+json',
    'Authorization':'Bearer '+GIST_TOKEN
  }, opts.headers||{});
  const res = await fetch('https://api.github.com'+path, { ...opts, headers });
  if(!res.ok){
    const t = await res.text().catch(()=>res.statusText);
    throw new Error('GitHub API '+res.status+': '+t);
  }
  return res.json();
}
async function gistLoad(){
  if(!GIST_ID || GIST_ID.startsWith('REPLACE_')) throw new Error('GIST_ID belum diisi');
  const out = await gh('/gists/'+GIST_ID);
  const file = out.files[FILE_NAME] || Object.values(out.files).find(f=>/\.json$/i.test(f.filename));
  if(!file) throw new Error('File JSON tidak ditemukan di Gist');
  const resp = await fetch(file.raw_url);
  return await resp.json();
}
async function gistSave(data){
  if(!GIST_ID || GIST_ID.startsWith('REPLACE_')) throw new Error('GIST_ID belum diisi');
  const body = { files: { [FILE_NAME]: { content: JSON.stringify(data, null, 2) } } };
  await gh('/gists/'+GIST_ID, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
}

/** ===================  AUTO LOAD & AUTO SAVE  =================== */
let lastJSON = '';
let saveTimer = null;
function jsonOf(d){ try{return JSON.stringify(d);}catch{ return ''; } }
function scheduleSave(){
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(async ()=>{
    try{
      const d = app().collectAllData();
      const j = jsonOf(d);
      if (j && j !== lastJSON){
        setStatus('Menyimpan ke Gist…'); setDot('warn');
        await gistSave(d);
        lastJSON = j;
        setStatus('Tersimpan'); setDot('ok');
        setMeta('Terakhir simpan: '+new Date().toLocaleString('id-ID'));
      }
    }catch(e){
      setStatus('Gagal simpan'); setDot('err'); setMeta(e.message||e);
    }
  }, 1200);
}

async function initialLoad(){
  try{
    setStatus('Memuat dari Gist…'); setDot('warn');
    const data = await gistLoad();
    app().applyAllData(data);
    lastJSON = jsonOf(app().collectAllData());
    setStatus('Dimuat dari Gist'); setDot('ok');
    setMeta('Terakhir muat: '+new Date().toLocaleString('id-ID'));
  }catch(e){
    setStatus('Lewati muat otomatis'); setDot('err'); setMeta(e.message||e);
  }
}

/** Pasang listener perubahan di dalam iframe (input/select/change),
 *  plus observer DOM untuk jaga-jaga */
function hookChangeWatch(){
  try{
    const doc = appFrame.contentDocument || appFrame.contentWindow.document;
    const rearm = () => {
      ['input','change','keyup','blur','click'].forEach(ev=>{
        doc.addEventListener(ev, ()=> scheduleSave(), { passive:true });
      });
    };
    rearm();
    // observe body changes
    const mo = new MutationObserver(()=> scheduleSave());
    mo.observe(doc.body, { subtree:true, childList:true, attributes:true, characterData:true });
  }catch(e){
    // silent
  }
}

/** ===================  KONTROL MANUAL  =================== */
btnNow.addEventListener('click', ()=> scheduleSave());
btnLoad.addEventListener('click', async ()=>{
  try{
    const data = await gistLoad();
    app().applyAllData(data);
    lastJSON = jsonOf(app().collectAllData());
    setStatus('Dimuat dari Gist'); setDot('ok');
    setMeta('Terakhir muat: '+new Date().toLocaleString('id-ID'));
  }catch(e){
    setStatus('Gagal muat'); setDot('err'); setMeta(e.message||e);
  }
});

/** ===================  BOOT  =================== */
window.addEventListener('load', ()=>{
  // ketika app.html sudah siap, lakukan initialLoad dan pasang watcher
  const wait = setInterval(()=>{
    try{
      app(); // akan throw kalau belum siap
      clearInterval(wait);
      initialLoad().then(()=> hookChangeWatch());
    }catch(_){}
  }, 150);

  // default minimized agar tidak nutupi konten
  setExpanded(false);
});
</script>
</body>
</html>
