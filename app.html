<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absensi - App</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#11182d;--muted:#6b7280;--text:#e5e7eb;--line:#24324d;
      --accent:#60a5fa;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--bad:#ef4444;--mid:#f59e0b;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    h1{font-size:18px;margin:12px 0}
    .wrap{max-width:1200px;margin:0 auto;padding:14px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px}
    .toolbar .group{display:flex;gap:8px;align-items:center}
    input[type="text"],input[type="number"],select{background:#0e152a;border:1px solid var(--line);color:var(--text);border-radius:8px;padding:6px 8px;font:inherit}
    input[type="number"]{width:68px}
    button{border:1px solid var(--line);background:#0e152a;color:var(--text);border-radius:10px;padding:8px 10px;font-weight:600;cursor:pointer}
    button.primary{background:var(--accent);border-color:var(--accent);color:#0b1020}
    button.danger{border-color:#7f1d1d;background:#1f0f12}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px}
    thead th{position:sticky;top:0;background:var(--panel);z-index:2}
    th,td{border-bottom:1px solid var(--line);padding:6px 8px;text-align:center}
    th.name,td.name{text-align:left;position:sticky;left:0;background:var(--panel);z-index:1}
    tbody tr:nth-child(odd) td{background:#0c142a}
    tbody tr:nth-child(even) td{background:#0b1326}
    .wday{font-size:11px;color:var(--muted)}
    .sat{background:#0f1b33}
    .sun{background:#0d1222;color:#9ca3af}
    .score.bad{outline:2px solid var(--bad)}
    .score.mid{outline:2px solid var(--warn)}
    .avg.bad{color:var(--bad);font-weight:700}
    .avg.mid{color:var(--warn);font-weight:700}
    .pill{display:inline-block;border:1px solid var(--line);padding:2px 6px;border-radius:999px;font-size:12px}
    .hint{color:var(--muted);font-size:12px}
    dialog{border:1px solid var(--line);border-radius:12px;background:var(--panel);color:var(--text);padding:14px;max-width:520px}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Absensi Kelas <span id="title">N4 Rasen</span> — <span id="monthsLabel">Sep–Nov 2025</span></h1>

  <div class="toolbar" role="region" aria-label="Toolbar">
    <div class="group" style="flex:1 1 auto">
      <label class="sr-only" for="newName">Nama</label>
      <input id="newName" type="text" placeholder="Tambah nama… (Enter)"/>
      <button id="addBtn" class="primary" type="button">Tambah</button>
      <span class="hint">Enter untuk tambah cepat</span>
    </div>
    <div class="group">
      <button id="sortAZ" type="button" title="Urut Abjad">Urut A→Z</button>
      <button id="sortAbs" type="button" title="Urut Mutlak (tetap)">Urut Mutlak</button>
    </div>
    <div class="group">
      <button id="downloadBtn" type="button" title="Unduh JSON">Unduh JSON</button>
      <input id="fileInput" class="sr-only" type="file" accept="application/json">
      <button id="uploadBtn" type="button" title="Muat JSON">Muat JSON…</button>
      <button id="printBtn" type="button" title="Cetak / PDF">Cetak / PDF</button>
      <button id="clearAll" class="danger" type="button" title="Hapus semua data">Clear All</button>
    </div>
  </div>

  <div class="hint" style="margin-top:6px">Selasa & Kamis memiliki kolom <em>taisou</em>. Sabtu hanya <em>taisou</em>. Minggu non-aktif.</div>

  <table id="tbl">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- Modal Cetak / PDF -->
<dialog id="printDlg">
  <form method="dialog">
    <h3 style="margin:0 0 8px">Cetak / Ekspor PDF</h3>
    <div style="display:grid;gap:8px">
      <label>Urutan siswa saat rekap:
        <select id="printOrder">
          <option value="abs">Urut Mutlak (tetap)</option>
          <option value="az">Urut Abjad (A→Z)</option>
          <option value="rank">Urut Rangking (Rata-rata tertinggi → terendah)</option>
        </select>
      </label>
      <label>Rentang bulan:
        <select id="printMonths">
          <option value="all">Semua bulan</option>
          <option value="m0">Bulan 1</option>
          <option value="m1">Bulan 2</option>
          <option value="m2">Bulan 3</option>
        </select>
      </label>
      <p class="hint">Rekap berisi: Nama, Hadir/Sakit/Izin/Alpa/半, Tidak Taisou, dan Rata-rata.</p>
    </div>
    <div class="modal-actions">
      <button value="cancel" type="button">Batal</button>
      <button id="goPrint" value="default" type="button" class="primary">Buka Mode Cetak</button>
    </div>
  </form>
</dialog>

<!-- Modal konfirmasi Clear All -->
<dialog id="wipeDlg">
  <form method="dialog">
    <h3 style="margin:0 0 8px;color:#fca5a5">Hapus Semua Data</h3>
    <p>Langkah ini akan mengosongkan seluruh nama & nilai. Untuk konfirmasi, ketik: <b>HAPUS SEMUA</b></p>
    <input id="wipeConfirm" type="text" placeholder="ketik di sini"/>
    <div class="modal-actions">
      <button value="cancel" type="button">Batal</button>
      <button id="doWipe" value="default" type="button" class="danger" disabled>Hapus</button>
    </div>
  </form>
</dialog>

<script>
/********************
 * KONFIG & STATE
 ********************/
const TITLE = 'N4 Rasen';
const MONTHS = [
  { label:'Sep 2025', ym:'2025-09' },
  { label:'Okt 2025', ym:'2025-10' },
  { label:'Nov 2025', ym:'2025-11' }
];

// Hari: 0=Min ... 6=Sab
const TUES=2, THU=4, SAT=6, SUN=0;

/** Struktur data **/
let PEOPLE = [
  // {id:'uuid', name:'Nama'}
];
let DATES = MONTHS.map(m => buildDatesOfMonth(m.ym)); // array of arrays
// DATA[monthIndex][rowIndex][colIndex] = { a:att, t:taisou, s:score }
let DATA = DATES.map(days => []);

/********************
 * UTILITAS WAKTU & ARRAY
 ********************/
function buildDatesOfMonth(ym){
  const [y,m] = ym.split('-').map(Number); // m: 1-12 => Date pakai 0-11
  const nDays = new Date(y, m, 0).getDate();
  const out = [];
  for(let d=1; d<=nDays; d++){
    const dt = new Date(y, m-1, d);
    out.push({ y, m, d, w: dt.getDay() });
  }
  return out;
}

function dayLabel(w){
  return ['Min','Sen','Sel','Rab','Kam','Jum','Sab'][w];
}

function clampScore(v){
  if(v===''||v===null||v===undefined) return null;
  let n = Number(v);
  if(!Number.isFinite(n)) return null;
  n = Math.max(0, Math.min(100, Math.round(n)));
  return n;
}

function uuid(){
  return (crypto.randomUUID? crypto.randomUUID() : 'id-'+Math.random().toString(36).slice(2));
}

/********************
 * RENDER TABLE
 ********************/
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');

function renderHead(){
  const cols = [ 'Nama' ];
  // tanggal header
  DATES.forEach((days, mi)=>{
    days.forEach((d,ci)=>{
      cols.push(`${d.d}<div class="wday">${dayLabel(d.w)}</div>`);
    });
  });
  // ringkasan
  cols.push('Hadir','Sakit','Izin','Alpa','半','No Taisou','Rata²');

  // baris head 1
  const tr = document.createElement('tr');
  cols.forEach((html,i)=>{
    const th = document.createElement('th');
    th.innerHTML = html;
    if(i===0) th.className='name';
    // beri kelas weekend
    if(i>0){
      const idx = i-1;
      // hitung m/c berdasarkan panjang
      let acc=0, mi=0, ci=0;
      while(mi<DATES.length){
        if(idx < acc + DATES[mi].length){ ci = idx-acc; break; }
        acc += DATES[mi].length; mi++;
      }
      const w = DATES[mi][ci].w;
      if(w===SAT) th.classList.add('sat');
      if(w===SUN) th.classList.add('sun');
    }
    tr.appendChild(th);
  });
  thead.innerHTML='';
  thead.appendChild(tr);
}

function ensureRowCapacity(){
  DATES.forEach((days, mi)=>{
    while(DATA[mi].length < PEOPLE.length){
      DATA[mi].push(days.map(()=> ({a:'', t:'', s:null})));
    }
  });
}

function renderBody(){
  ensureRowCapacity();
  const frag = document.createDocumentFragment();

  PEOPLE.forEach((p, ri)=>{
    const tr = document.createElement('tr');

    const tdName = document.createElement('td');
    tdName.className='name';
    tdName.textContent = p.name;
    tr.appendChild(tdName);

    // tanggal cells
    DATES.forEach((days, mi)=>{
      days.forEach((d, ci)=>{
        const td = document.createElement('td');
        td.dataset.r = ri; td.dataset.m = mi; td.dataset.c = ci;
        const cell = DATA[mi][ri][ci];

        if(d.w===SUN){
          td.classList.add('sun');
          td.textContent='—';
        }else if(d.w===SAT){
          td.classList.add('sat');
          td.innerHTML = selectTaisou(cell.t);
        }else{
          td.innerHTML = selectAttend(cell.a) + ' ' + selectTaisou((d.w===TUES||d.w===THU)?cell.t:'') + ' ' + inputScore(cell.s);
        }
        frag.appendChild(tr);
        tr.appendChild(td);
      });
    });

    // ringkasan
    const sum = computeSummary(ri);
    tr.appendChild(summaryCell(sum.hadir));
    tr.appendChild(summaryCell(sum.sakit));
    tr.appendChild(summaryCell(sum.izin));
    tr.appendChild(summaryCell(sum.alpa));
    tr.appendChild(summaryCell(sum.half));
    tr.appendChild(summaryCell(sum.noTaisou));
    const tdAvg = document.createElement('td');
    tdAvg.textContent = isFinite(sum.avg)? sum.avg.toFixed(1) : '-';
    if(isFinite(sum.avg)){
      if(sum.avg<70) tdAvg.className='avg bad'; else if(sum.avg<80) tdAvg.className='avg mid';
    }
    tr.appendChild(tdAvg);

    frag.appendChild(tr);
  });

  tbody.innerHTML='';
  tbody.appendChild(frag);
}

function selectAttend(v){
  const opts = ['','hadir','sakit','izin','alpa','半'];
  return `<select class="att" aria-label="absen">${opts.map(o=>`<option value="${o}" ${o===v?'selected':''}>${o}</option>`).join('')}</select>`;
}
function selectTaisou(v){
  const opts = ['','hadir','tdk'];
  return `<select class="tai" aria-label="taisou">${opts.map(o=>`<option value="${o}" ${o===v?'selected':''}>${o||'—'}</option>`).join('')}</select>`;
}
function inputScore(v){
  return `<input class="score" type="number" min="0" max="100" step="1" value="${v??''}" aria-label="nilai">`;
}
function summaryCell(n){
  const td=document.createElement('td'); td.innerHTML=`<span class="pill">${n}</span>`; return td;
}

/********************
 * EVENT DELEGATION
 ********************/

tbody.addEventListener('change', onBodyChange);
tbody.addEventListener('input', onBodyInput);

function cellRefFromTarget(t){
  const td = t.closest('td');
  if(!td) return null;
  const ri = +td.dataset.r; const mi = +td.dataset.m; const ci = +td.dataset.c;
  if([ri,mi,ci].some(n=>Number.isNaN(n))) return null;
  return {ri,mi,ci, td};
}

function onBodyChange(e){
  const ref = cellRefFromTarget(e.target);
  if(!ref) return;
  const {ri,mi,ci,td} = ref;
  const d = DATES[mi][ci];
  const cell = DATA[mi][ri][ci];

  if(e.target.classList.contains('att')){
    cell.a = e.target.value||'';
  }
  if(e.target.classList.contains('tai')){
    // hanya berlaku selasa/kamis/sabtu; lainnya tetap kosong
    if(d.w===TUES||d.w===THU||d.w===SAT) cell.t = e.target.value||''; else cell.t='';
  }
  updateRowSummary(ri);
}

function onBodyInput(e){
  if(!e.target.classList.contains('score')) return;
  const ref = cellRefFromTarget(e.target); if(!ref) return;
  const {ri,mi,ci} = ref; const cell = DATA[mi][ri][ci];
  const n = clampScore(e.target.value);
  cell.s = n;
  e.target.value = n??'';
  e.target.classList.remove('bad','mid');
  if(n!==null){
    if(n<70) e.target.classList.add('bad'); else if(n<80) e.target.classList.add('mid');
    if(!cell.a) cell.a='hadir'; // isi nilai → set hadir bila kosong
  }
  updateRowSummary(ri);
}

function updateRowSummary(ri){
  // cukup re-render ringkasan kolom terakhir baris ri (hemat DOM)
  const tr = tbody.children[ri]; if(!tr) return;
  const sum = computeSummary(ri);
  const base = 1 + DATES.reduce((acc,days)=>acc+days.length,0); // offset sesudah semua tanggal
  tr.children[base+0].querySelector('.pill').textContent = sum.hadir;
  tr.children[base+1].querySelector('.pill').textContent = sum.sakit;
  tr.children[base+2].querySelector('.pill').textContent = sum.izin;
  tr.children[base+3].querySelector('.pill').textContent = sum.alpa;
  tr.children[base+4].querySelector('.pill').textContent = sum.half;
  tr.children[base+5].querySelector('.pill').textContent = sum.noTaisou;
  const tdAvg = tr.children[base+6];
  tdAvg.textContent = isFinite(sum.avg)? sum.avg.toFixed(1) : '-';
  tdAvg.classList.remove('bad','mid','avg');
  if(isFinite(sum.avg)){
    tdAvg.classList.add('avg');
    if(sum.avg<70) tdAvg.classList.add('bad'); else if(sum.avg<80) tdAvg.classList.add('mid');
  }
}

/********************
 * PERHITUNGAN RINGKASAN & RANKING
 ********************/
function computeSummary(ri, monthFilter='all'){
  let hadir=0,sakit=0,izin=0,alpa=0,half=0,noTaisou=0;
  let sum=0, cnt=0;
  const monthIdxs = monthFilter==='all' ? [0,1,2] : [monthFilter];

  monthIdxs.forEach(mi=>{
    const days = DATES[mi];
    for(let ci=0; ci<days.length; ci++){
      const d = days[ci]; const cell = DATA[mi][ri][ci];
      if(d.w===SUN){ continue; }
      if(d.w===SAT){ // sabtu
        if(cell.t==='tdk') noTaisou++;
        continue;
      }
      // kerja hari
      if(cell.a==='hadir') hadir++;
      else if(cell.a==='sakit') sakit++;
      else if(cell.a==='izin') izin++;
      else if(cell.a==='alpa') alpa++;
      else if(cell.a==='半') half++;
      if(d.w===TUES||d.w===THU){ if(cell.t==='tdk') noTaisou++; }
      if(cell.s!==null){ sum += cell.s; cnt++; }
    }
  });
  const avg = cnt? (sum/cnt) : NaN;
  return {hadir,sakit,izin,alpa,half,noTaisou,avg};
}

function ranking(order='desc', monthFilter='all'){
  const idx = PEOPLE.map((p,i)=>{
    const s = computeSummary(i, monthFilter);
    return {i, avg: isFinite(s.avg)? s.avg : -Infinity};
  });
  idx.sort((a,b)=> (order==='desc'? b.avg-a.avg : a.avg-b.avg));
  return idx.map(x=>x.i);
}

/********************
 * CETAK / PDF
 ********************/
const printDlg = document.getElementById('printDlg');
const printOrderSel = document.getElementById('printOrder');
const printMonths = document.getElementById('printMonths');
const goPrint = document.getElementById('goPrint');

document.getElementById('printBtn').addEventListener('click', ()=>{
  printDlg.showModal();
});

goPrint.addEventListener('click', ()=>{
  printDlg.close();
  const order = printOrderSel.value; // 'abs' | 'az' | 'rank'
  const m = printMonths.value; // 'all' | 'm0' | 'm1' | 'm2'
  const monthFilter = m==='all'? 'all' : Number(m.slice(1));

  // siapkan data rekap
  let rows = PEOPLE.map((p,i)=>({
    name: p.name,
    ...computeSummary(i, monthFilter)
  }));

  // urut sesuai pilihan
  if(order==='az') rows.sort((a,b)=> a.name.localeCompare(b.name,'id'));
  else if(order==='rank') rows.sort((a,b)=> (isFinite(b.avg)?b.avg:-Infinity) - (isFinite(a.avg)?a.avg:-Infinity));
  // 'abs' tetap sesuai PEOPLE

  // buat jendela cetak sederhana tanpa menyisipkan <\/script> dalam string
  const win = window.open('', '_blank');
  const title = document.getElementById('title').textContent || 'Kelas';
  const monthsText = document.getElementById('monthsLabel').textContent || '';
  const style = `body{font:13px/1.4 system-ui,Segoe UI,Roboto} table{border-collapse:collapse;width:100%} th,td{border:1px solid #999;padding:6px 8px;text-align:center} th{text-align:center;background:#f3f4f6} td.name{text-align:left}`;
  const head = `<h2 style=\"margin:6px 0\">Rekap ${title} — ${monthsText}</h2><div style=\"margin:4px 0\">Urutan: ${order==='az'?'Abjad':order==='rank'?'Rangking':'Mutlak'}. Bulan: ${m==='all'?'Semua':MONTHS[monthFilter].label}</div>`;
  const tHead = `<tr><th>Nama</th><th>Hadir</th><th>Sakit</th><th>Izin</th><th>Alpa</th><th>半</th><th>Tak Taisou</th><th>Rata-rata</th></tr>`;
  const tRows = rows.map(r=>`<tr><td class=\"name\">${escapeHtml(r.name)}</td><td>${r.hadir}</td><td>${r.sakit}</td><td>${r.izin}</td><td>${r.alpa}</td><td>${r.half}</td><td>${r.noTaisou}</td><td>${isFinite(r.avg)?r.avg.toFixed(1):'-'}</td></tr>`).join('');
  const html = `<!doctype html><html><head><meta charset=\"utf-8\"><title>Rekap</title><style>${style}</style></head><body>${head}<table>${tHead}${tRows}</table></body></html>`;
  win.document.open();
  win.document.write(html);
  win.document.close();
  setTimeout(()=>{ try { win.focus(); win.print(); } catch(_){} }, 50);
});
  const order = printOrderSel.value; // 'abs' | 'az' | 'rank'
  const m = printMonths.value; // 'all' | 'm0' | 'm1' | 'm2'
  const monthFilter = m==='all'? 'all' : Number(m.slice(1));

  // siapkan data rekap
  let rows = PEOPLE.map((p,i)=>({
    name: p.name,
    ...computeSummary(i, monthFilter)
  }));

  // urut sesuai pilihan
  if(order==='az') rows.sort((a,b)=> a.name.localeCompare(b.name,'id'));
  else if(order==='rank') rows.sort((a,b)=> (isFinite(b.avg)?b.avg:-Infinity) - (isFinite(a.avg)?a.avg:-Infinity));
  // 'abs' tetap sesuai PEOPLE

  // buat jendela cetak sederhana
  const win = window.open('', '_blank');
  const title = document.getElementById('title').textContent || 'Kelas';
  const monthsText = document.getElementById('monthsLabel').textContent || '';
  const style = `body{font:13px/1.4 system-ui,Segoe UI,Roboto} table{border-collapse:collapse;width:100%} th,td{border:1px solid #999;padding:6px 8px;text-align:center} th{text-align:center;background:#f3f4f6} td.name{text-align:left}`;
  const head = `<h2 style="margin:6px 0">Rekap ${title} — ${monthsText}</h2><div style="margin:4px 0">Urutan: ${order==='az'?'Abjad':order==='rank'?'Rangking':'Mutlak'}. Bulan: ${m==='all'?'Semua':MONTHS[monthFilter].label}</div>`;
  const tHead = `<tr><th>Nama</th><th>Hadir</th><th>Sakit</th><th>Izin</th><th>Alpa</th><th>半</th><th>Tak Taisou</th><th>Rata-rata</th></tr>`;
  const tRows = rows.map(r=>`<tr><td class="name">${escapeHtml(r.name)}</td><td>${r.hadir}</td><td>${r.sakit}</td><td>${r.izin}</td><td>${r.alpa}</td><td>${r.half}</td><td>${r.noTaisou}</td><td>${isFinite(r.avg)?r.avg.toFixed(1):'-'}</td></tr>`).join('');
  win.document.write(`<html><head><meta charset="utf-8"><title>Rekap</title><style>${style}</style></head><body>${head}<table>${tHead}${tRows}</table><script>window.onload=()=>window.print()<\/script></body></html>`);
  win.document.close();
});

/********************
 * UNDUH / MUAT JSON
 ********************/
const downloadBtn = document.getElementById('downloadBtn');
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');

function downloadJSON(){
  const data = collectAllData();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  const title = document.getElementById('title').textContent || 'kelas';
  a.download = `${title.replace(/\s+/g,'_')}_${MONTHS.map(m=>m.label.split(' ')[0]).join('-')}.json`;
  a.href = URL.createObjectURL(blob);
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

function uploadJSON(){
  fileInput.click();
}

fileInput.addEventListener('change', async ()=>{
  const f = fileInput.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const j = JSON.parse(text);
    applyAllData(j);
  }catch(e){ alert('Gagal memuat JSON: '+(e.message||e)); }
  finally{ fileInput.value=''; }
});

downloadBtn.addEventListener('click', downloadJSON);
uploadBtn.addEventListener('click', uploadJSON);

/********************
 * TAMBAH NAMA & SORT
 ********************/
const addBtn = document.getElementById('addBtn');
const newName = document.getElementById('newName');

function addPerson(){
  const v = (newName.value||'').trim();
  if(!v) return;
  PEOPLE.push({id:uuid(), name:v});
  newName.value='';
  renderBody();
}
addBtn.addEventListener('click', addPerson);
newName.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addPerson(); }});

const sortAZ = document.getElementById('sortAZ');
const sortAbs = document.getElementById('sortAbs');
let ABSOLUTE_ORDER = []; // simpan id urutan mutlak

function recordAbsolute(){ ABSOLUTE_ORDER = PEOPLE.map(p=>p.id); }

sortAZ.addEventListener('click', ()=>{
  PEOPLE.sort((a,b)=> a.name.localeCompare(b.name,'id'));
  renderBody();
});
sortAbs.addEventListener('click', ()=>{
  if(!ABSOLUTE_ORDER.length) return;
  PEOPLE.sort((a,b)=> ABSOLUTE_ORDER.indexOf(a.id) - ABSOLUTE_ORDER.indexOf(b.id));
  renderBody();
});

/********************
 * CLEAR ALL (double confirm)
 ********************/
const wipeDlg = document.getElementById('wipeDlg');
const wipeConfirm = document.getElementById('wipeConfirm');
const doWipe = document.getElementById('doWipe');

document.getElementById('clearAll').addEventListener('click', ()=>{
  wipeConfirm.value=''; doWipe.disabled=true; wipeDlg.showModal();
});

wipeConfirm.addEventListener('input', ()=>{
  doWipe.disabled = wipeConfirm.value.trim() !== 'HAPUS SEMUA';
});

doWipe.addEventListener('click', ()=>{
  wipeDlg.close();
  PEOPLE = [];
  DATA = DATES.map(days=>[]);
  renderBody();
});

/********************
 * EXPORT UNTUK INDEX.HTML
 ********************/
function collectAllData(){
  return { title: TITLE, months: MONTHS, people: PEOPLE, dates: DATES, data: DATA };
}

function coerceCell(x, d){
  const out = {a:'', t:'', s:null};
  if(x && typeof x==='object'){
    if(typeof x.a==='string') out.a = x.a;
    if(typeof x.t==='string') out.t = (d.w===TUES||d.w===THU||d.w===SAT)? x.t : '';
    const s = clampScore(x.s);
    out.s = (d.w===SUN||d.w===SAT)? null : s;
  }
  return out;
}

function applyAllData(j){
  try{
    // Back-compat: jika people berupa array string, konversi ke {id,name}
    if(Array.isArray(j.people)){
      PEOPLE = j.people.map(p=> typeof p==='string'? {id:uuid(), name:p} : {id:p.id||uuid(), name:p.name||''});
    }
    if(Array.isArray(j.months) && j.months.length===3){
      // keep our MONTHS but recalc dates if ym berbeda
      const same = j.months.every((m,i)=> m.ym===MONTHS[i].ym);
      if(!same){
        // optional: adopt incoming months
        // MONTHS = j.months; // (biarkan tetap — bisa diaktifkan jika mau sinkron penuh)
      }
    }
    if(Array.isArray(j.dates) && j.dates.length===3){
      // coercion tanggal (pakai tanggal bawaan app agar stabil)
    }

    // DATA
    DATA = DATES.map((days,mi)=>{
      const rows = (j.data && j.data[mi])? j.data[mi] : [];
      const outRows = [];
      for(let ri=0; ri<PEOPLE.length; ri++){
        const row = rows[ri] || [];
        outRows.push(days.map((d,ci)=> coerceCell(row[ci], d)));
      }
      return outRows;
    });

    recordAbsolute();
    renderHead();
    renderBody();
  }catch(e){
    alert('Gagal apply data: '+(e.message||e));
  }
}

/********************
 * MISC
 ********************/
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

/********************
 * BOOT
 ********************/
(function boot(){
  document.getElementById('title').textContent = TITLE;
  document.getElementById('monthsLabel').textContent = MONTHS.map(m=>m.label).join(' – ');
  recordAbsolute();
  renderHead();
  renderBody();
})();
<\/script>
</body>
</html>
